# =============================================================================
# Simplified NLP Pipeline (SQLite + Streamlit)
# =============================================================================
# 
# This docker-compose.yml is simplified to remove PostgreSQL and Label Studio.
# - SQLite database is used directly (no container needed)
# - Streamlit review app runs locally or via Tailscale
#
# Changes:
#   - Removed: postgres, labelstudio, sync_service containers
#   - Kept: audio_server (for serving audio files)
#   - Simplified: ingestion service (no database dependency)
# =============================================================================

services:
  # --- Audio Server (nginx) ---
  # Serves audio files for the Streamlit review app
  audio_server:
    image: nginx:alpine
    container_name: audio_server
    restart: unless-stopped
    ports:
      - "8081:80"
    volumes:
      - ./data/raw/audio:/usr/share/nginx/html/audio:ro
      - ./data/denoised:/usr/share/nginx/html/denoised:ro
      - ./data/segments:/usr/share/nginx/html/segments:ro
      - ./data/export:/usr/share/nginx/html/export:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "nginx -t && kill -0 $$(cat /var/run/nginx.pid)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  # --- Ingestion Service ---
  # For YouTube downloading (runs on-demand, not always-on)
  ingestion:
    build:
      context: .
      dockerfile: Dockerfile.ingest
    container_name: factory_ingestion
    volumes:
      - .:/app
      - ./data:/app/data
      - ./.secrets:/app/.secrets:ro
      - ~/.cache/pydrive2fs:/root/.cache/pydrive2fs
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/app/.secrets/client_secret_952625721816-dc9kkk15i2leugvjl8f885rqkut975bo.apps.googleusercontent.com.json
      - GEMINI_API_KEY_1=${GEMINI_API_KEY_1:-}
      - GEMINI_API_KEY_2=${GEMINI_API_KEY_2:-}
    # Run in interactive mode by default
    stdin_open: true
    tty: true
    command: /bin/bash

  # --- Streamlit Review App ---
  # Optional: Run Streamlit in Docker
  # Alternatively, run locally with: streamlit run src/review_app.py
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.ingest
    container_name: streamlit_review
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    command: streamlit run src/review_app.py --server.port 8501 --server.address 0.0.0.0
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8501/_stcore/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# =============================================================================
# Usage Instructions:
# =============================================================================
#
# Start audio server only:
#   docker-compose up -d audio_server
#
# Start Streamlit review app:
#   docker-compose up -d streamlit
#
# Or run Streamlit locally (recommended for development):
#   streamlit run src/review_app.py
#
# Run ingestion interactively:
#   docker-compose run --rm ingestion bash
#   python src/ingest_youtube.py https://youtube.com/...
#
# =============================================================================
