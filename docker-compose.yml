services:
  # --- 1.2.2 The Ledger (Metadata Store) ---
  postgres:
    image: postgres:15
    container_name: factory_ledger
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret_password
      POSTGRES_DB: data_factory
    ports:
      - "5432:5432"
    volumes:
      - ./database_data:/var/lib/postgresql/data
      # Mount the init script to auto-create tables
      - ./init_scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d data_factory"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- Label Studio for annotation ---
  label_studio:
    image: heartexlabs/label-studio:latest
    container_name: label_studio
    restart: always
    ports:
      - "8080:8080"
    volumes:
      - label_studio_data:/label-studio/data
      # Mount templates for labeling interfaces
      - ./label_studio_templates:/label-studio/templates:ro
    environment:
      - LABEL_STUDIO_LOCAL_FILES_SERVING_ENABLED=true
      - LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/label-studio/files
      # PostgreSQL backend for Label Studio (optional, uses SQLite by default)
      # - DJANGO_DB=default
      # - POSTGRE_NAME=label_studio
      # - POSTGRE_USER=admin
      # - POSTGRE_PASSWORD=secret_password
      # - POSTGRE_HOST=postgres
      # - POSTGRE_PORT=5432
    depends_on:
      postgres:
        condition: service_healthy

  # --- nginx audio server for serving audio files to Label Studio ---
  audio_server:
    image: nginx:alpine
    container_name: audio_server
    restart: always
    ports:
      - "8081:80"
    volumes:
      - ./data/raw/audio:/usr/share/nginx/html/audio:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # --- DVC sync service for automatic data synchronization ---
  sync_service:
    build:
      context: .
      dockerfile: Dockerfile.ingest
    container_name: sync_service
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      audio_server:
        condition: service_healthy
    volumes:
      - .:/app
      - ./data:/app/data
      - ~/.cache/pydrive2fs:/root/.cache/pydrive2fs
    environment:
      - DATABASE_URL=postgresql://admin:secret_password@postgres:5432/data_factory
      - SYNC_INTERVAL_MINUTES=5
      - AUDIO_SERVER_URL=http://audio_server:80
      - LABEL_STUDIO_URL=http://label_studio:8080
      - LABEL_STUDIO_API_KEY=${LABEL_STUDIO_API_KEY:-}
    command: python src/sync_daemon.py

  # --- 1.3 Ingestion Service ---
  ingestion:
    build:
      context: .
      dockerfile: Dockerfile.ingest
    container_name: factory_ingestion
    depends_on:
      postgres:
        condition: service_healthy # Wait for DB to be ready before starting
    volumes:
      # Bind Mount 1: The Code (so you can edit python files locally and run them inside)
      - .:/app
      # Bind Mount 2: The Data (so downloaded files appear on your host disk)
      - ./data:/app/data
      # Bind Mount 3: Google Auth (for DVC)
      - ~/.cache/pydrive2fs:/root/.cache/pydrive2fs 
    environment:
      # Connection string for the Python script
      - DATABASE_URL=postgresql://admin:secret_password@postgres:5432/data_factory
      - AUDIO_SERVER_URL=http://audio_server:80
      - LABEL_STUDIO_URL=http://label_studio:8080
      - LABEL_STUDIO_API_KEY=${LABEL_STUDIO_API_KEY:-}

volumes:
  database_data:
  label_studio_data: