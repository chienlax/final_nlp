server {
    listen 80;
    server_name localhost;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Serve raw audio files with CORS headers for Streamlit
    location /audio/ {
        alias /usr/share/nginx/html/audio/;
        
        # CORS headers for Streamlit audio player
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
        add_header Access-Control-Expose-Headers 'Content-Length,Content-Range';
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }

        # Audio file types
        types {
            audio/wav wav;
            audio/mpeg mp3;
            audio/ogg ogg;
            audio/flac flac;
        }

        # Enable byte-range requests for audio seeking
        add_header Accept-Ranges bytes;
        
        # Cache audio files for 1 hour
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # Serve segment audio files (pre-cut segments)
    # URL: /segments/{sample_id}/0000.wav
    location /segments/ {
        alias /usr/share/nginx/html/segments/;
        
        # CORS headers for Label Studio access
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
        add_header Access-Control-Expose-Headers 'Content-Length,Content-Range';
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }

        # Audio file types
        types {
            audio/wav wav;
        }

        # Enable byte-range requests for audio seeking
        add_header Accept-Ranges bytes;
        
        # Cache segment files for 1 hour
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # Serve review audio files (pre-cut sentence audio for unified review)
    # URL: /review/{sample_id}/sentences/0001.wav
    location /review/ {
        alias /usr/share/nginx/html/review/;
        
        # CORS headers for Label Studio access
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
        add_header Access-Control-Expose-Headers 'Content-Length,Content-Range';
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }

        # Audio file types
        types {
            audio/wav wav;
        }

        # Enable byte-range requests for audio seeking
        add_header Accept-Ranges bytes;
        
        # Cache review files for 30 minutes (shorter since they're temporary)
        expires 30m;
        add_header Cache-Control "public, max-age=1800";
    }

    # Serve final audio files (corrected sentence audio after review)
    # URL: /final/{sample_id}/sentences/0001.wav
    location /final/ {
        alias /usr/share/nginx/html/final/;
        
        # CORS headers for Label Studio access
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
        add_header Access-Control-Expose-Headers 'Content-Length,Content-Range';
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }

        # Audio file types
        types {
            audio/wav wav;
        }

        # Enable byte-range requests for audio seeking
        add_header Accept-Ranges bytes;
        
        # Cache final files for 1 day (permanent after review)
        expires 1d;
        add_header Cache-Control "public, max-age=86400";
    }

    # Default error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
