server {
    listen 80;
    server_name localhost;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Serve audio files with CORS headers for Label Studio
    location /audio/ {
        alias /usr/share/nginx/html/audio/;
        
        # CORS headers for Label Studio access
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
        add_header Access-Control-Expose-Headers 'Content-Length,Content-Range';
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }

        # Audio file types
        types {
            audio/wav wav;
            audio/mpeg mp3;
            audio/ogg ogg;
            audio/flac flac;
        }

        # Enable byte-range requests for audio seeking
        add_header Accept-Ranges bytes;
        
        # Cache audio files for 1 hour
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # Default error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
