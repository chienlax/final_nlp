<!DOCTYPE html><html><head>
      <title>04_workflow</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\Quang Chien\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="04-workflow-documentation">04. Workflow Documentation </h1>
<h2 id="overview">Overview </h2>
<p>This document describes the complete data ingestion and processing workflow for the Vietnamese-English Code-Switching Speech Translation project. The system supports two primary data pipelines based on the input modality.</p>
<p><strong>Related Documentation:</strong></p>
<ul>
<li><a href="07_label_studio.md">07. Label Studio Integration</a> - Detailed annotation workflow</li>
<li><a href="06_database_design.md">06. Database Design</a> - Schema and versioning</li>
</ul>
<hr>
<h2 id="1-high-level-architecture">1. High-Level Architecture </h2>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                           DATA SOURCES                                       │
├─────────────────────────────────┬───────────────────────────────────────────┤
│       YOUTUBE (Audio-First)     │         SUBSTACK (Text-First)             │
│  - Video/Channel URLs           │  - Blog article URLs                      │
│  - 16kHz mono WAV extraction    │  - Markdown/text extraction               │
│  - Transcript w/ timestamps     │  - Teencode normalization                 │
└─────────────────┬───────────────┴──────────────────────┬────────────────────┘
                  │                                      │
                  ▼                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         RAW DATA STORAGE                                     │
│                        (DVC-versioned)                                       │
│  data/raw/audio/     - WAV files (16kHz mono)                               │
│  data/raw/text/      - Transcript JSON files (with timestamps)               │
│  data/raw/metadata.jsonl - Batch metadata                                   │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
            ┌─────────────────────┴─────────────────────┐
            │                                           │
            ▼                                           ▼
┌───────────────────────────────┐     ┌───────────────────────────────────────┐
│      POSTGRESQL DATABASE       │     │          DVC SYNC DAEMON              │
│  - sources: Origin tracking    │     │  - Auto-sync every 5 minutes          │
│  - samples: Central registry   │     │  - Pulls new data from Google Drive   │
│  - transcript_revisions        │     │  - Pushes local changes upstream      │
│  - translation_revisions       │     │  - Records commit hashes              │
│  - annotations: Label Studio   │     │                                       │
│  - processing_logs: Audit      │     │  Script: src/sync_daemon.py           │
└───────────────────┬───────────┘     └───────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      PROCESSING PIPELINES                                    │
│  (Future: MFA alignment, VAD segmentation, DeepFilterNet, TTS)              │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       LABEL STUDIO ANNOTATION                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────────────┐        │
│  │ Transcript      │  │ Translation     │  │ Audio Segmentation   │        │
│  │ Correction      │  │ Review          │  │ (Future)             │        │
│  └────────┬────────┘  └────────┬────────┘  └──────────┬───────────┘        │
│           │                    │                      │                     │
│           └────────────────────┴──────────────────────┘                     │
│                                │                                            │
│                       ┌────────▼────────┐                                   │
│                       │ Webhook Server   │                                  │
│                       │ (Conflict Check) │                                  │
│                       └────────┬────────┘                                   │
│                                │                                            │
│                       ┌────────▼────────┐                                   │
│                       │ Export Pipeline  │                                  │
│                       └─────────────────┘                                   │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre><hr>
<h2 id="2-audio-first-pipeline-youtube">2. Audio-First Pipeline (YouTube) </h2>
<p>This pipeline is designed for YouTube videos that contain Vietnamese-English code-switching speech.</p>
<h3 id="21-pipeline-states">2.1 Pipeline States </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>RAW → ALIGNED → SEGMENTED → ENHANCED → TRANSLATED → REVIEWED
          ↓
     (alternative if no transcript)
          ↓
     VAD_SEGMENTED → ALIGNED → ...
</code></pre><h3 id="22-workflow-steps">2.2 Workflow Steps </h3>
<table>
<thead>
<tr>
<th>Step</th>
<th>Task</th>
<th>Processing State</th>
<th>Script</th>
<th>Section</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Download audio (16kHz WAV)</td>
<td>-</td>
<td><code>ingest_youtube.py</code></td>
<td><a href="05_scripts_details.md#51-ingest_youtubepy">§5.1</a></td>
</tr>
<tr>
<td>2</td>
<td>Download transcript w/ timestamps</td>
<td>RAW</td>
<td><code>ingest_youtube.py</code></td>
<td><a href="05_scripts_details.md#51-ingest_youtubepy">§5.1</a></td>
</tr>
<tr>
<td>3</td>
<td>Calculate CS ratio</td>
<td>RAW</td>
<td><code>ingest_youtube.py</code></td>
<td><a href="05_scripts_details.md#51-ingest_youtubepy">§5.1</a></td>
</tr>
<tr>
<td>4</td>
<td>Insert to database</td>
<td>RAW</td>
<td><code>ingest_youtube.py</code></td>
<td><a href="05_scripts_details.md#51-ingest_youtubepy">§5.1</a></td>
</tr>
<tr>
<td>5</td>
<td>MFA Forced Alignment</td>
<td>ALIGNED</td>
<td><em>Future</em></td>
<td>-</td>
</tr>
<tr>
<td>6</td>
<td>Audio Segmentation</td>
<td>SEGMENTED</td>
<td><em>Future</em></td>
<td>-</td>
</tr>
<tr>
<td>7</td>
<td>Audio Enhancement (DeepFilterNet)</td>
<td>ENHANCED</td>
<td><em>Future</em></td>
<td>-</td>
</tr>
<tr>
<td>8</td>
<td>LLM Translation</td>
<td>TRANSLATED</td>
<td><em>Future</em></td>
<td>-</td>
</tr>
<tr>
<td>9</td>
<td>Human Review (Label Studio)</td>
<td>REVIEWED</td>
<td><code>label_studio_sync.py</code></td>
<td><a href="05_scripts_details.md#53-label_studio_syncpy">§5.3</a></td>
</tr>
</tbody>
</table>
<h3 id="23-detailed-sub-tasks">2.3 Detailed Sub-Tasks </h3>
<h4 id="step-1-audio-download">Step 1: Audio Download </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Input:  YouTube URL (video or channel)
Output: data/raw/audio/{video_id}.wav

Sub-tasks:
├── Validate URL format
├── Extract video metadata (yt-dlp)
├── Filter by duration (2-60 min)
├── Download best audio stream
├── Convert to 16kHz mono WAV (ffmpeg)
└── Log to downloaded_videos_log

Related Script: src/utils/video_downloading_utils.py
  └── download_channels()
  └── _duration_filter()
  └── progress_hook()
</code></pre><h4 id="step-2-transcript-download">Step 2: Transcript Download </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Input:  Video ID from metadata.jsonl
Output: data/raw/text/{video_id}_transcript.json

Sub-tasks:
├── List available transcripts (manual vs auto-generated)
├── Prioritize: Manual EN &gt; Auto EN &gt; Manual VI &gt; Auto VI
├── Fetch transcript segments with timestamps
├── Convert to JSON format with start/end times
└── Update metadata.jsonl with transcript info

Related Script: src/utils/transcript_downloading_utils.py
  └── get_transcript_info()
  └── download_transcripts_from_metadata()

Output Format:
{
  "video_id": "xxx",
  "language": "en",
  "subtitle_type": "Manual",
  "segments": [
    {"text": "...", "start": 0.47, "duration": 0.95, "end": 1.42},
    ...
  ],
  "full_text": "..."
}
</code></pre><h4 id="step-3-cs-ratio-calculation">Step 3: CS Ratio Calculation </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Input:  Transcript text
Output: Float (0.0 - 1.0)

Sub-tasks:
├── Tokenize text into words
├── Detect Vietnamese particles
├── Detect English stop words
├── Calculate intersection ratio

Related Script: src/utils/data_utils.py
  └── calculate_cs_ratio()
</code></pre><h4 id="step-4-database-ingestion">Step 4: Database Ingestion </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Input:  Metadata entries with file paths
Output: PostgreSQL records (sources, samples, transcript_revisions)

Sub-tasks:
├── Get or create source record
├── Insert sample record (RAW state)
├── Insert transcript revision (version 1)
├── Log processing step

Related Script: src/utils/data_utils.py
  └── get_or_create_source()
  └── insert_sample()
  └── insert_transcript_revision()
</code></pre><hr>
<h2 id="3-text-first-pipeline-substack">3. Text-First Pipeline (Substack) </h2>
<p>This pipeline processes Substack blog articles that contain code-switching text.</p>
<h3 id="31-pipeline-states">3.1 Pipeline States </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>RAW → NORMALIZED → CS_CHUNKED → TTS_GENERATED → TRANSLATED → REVIEWED
</code></pre><h3 id="32-workflow-steps">3.2 Workflow Steps </h3>
<table>
<thead>
<tr>
<th>Step</th>
<th>Task</th>
<th>Processing State</th>
<th>Script</th>
<th>Section</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Download article (HTML→Text)</td>
<td>-</td>
<td><code>ingest_substack.py</code></td>
<td><a href="05_scripts_details.md#52-ingest_substackpy">§5.2</a></td>
</tr>
<tr>
<td>2</td>
<td>Normalize text (teencode)</td>
<td>RAW</td>
<td><code>ingest_substack.py</code></td>
<td><a href="05_scripts_details.md#52-ingest_substackpy">§5.2</a></td>
</tr>
<tr>
<td>3</td>
<td>Extract CS chunks</td>
<td>NORMALIZED</td>
<td><code>ingest_substack.py</code></td>
<td><a href="05_scripts_details.md#52-ingest_substackpy">§5.2</a></td>
</tr>
<tr>
<td>4</td>
<td>Insert to database</td>
<td>RAW</td>
<td><code>ingest_substack.py</code></td>
<td><a href="05_scripts_details.md#52-ingest_substackpy">§5.2</a></td>
</tr>
<tr>
<td>5</td>
<td>TTS Generation (XTTS v2)</td>
<td>TTS_GENERATED</td>
<td><em>Future</em></td>
<td>-</td>
</tr>
<tr>
<td>6</td>
<td>LLM Translation</td>
<td>TRANSLATED</td>
<td><em>Future</em></td>
<td>-</td>
</tr>
<tr>
<td>7</td>
<td>Human Review (Label Studio)</td>
<td>REVIEWED</td>
<td><code>label_studio_sync.py</code></td>
<td><a href="05_scripts_details.md#53-label_studio_syncpy">§5.3</a></td>
</tr>
</tbody>
</table>
<h3 id="33-detailed-sub-tasks">3.3 Detailed Sub-Tasks </h3>
<h4 id="step-1-article-download">Step 1: Article Download </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Input:  Substack article URL
Output: data/raw/text/substack/{blog_slug}/{article_slug}.txt

Sub-tasks:
├── Extract blog slug from URL
├── Fetch HTML content (requests)
├── Parse article body (BeautifulSoup)
├── Extract title and content
├── Convert to clean text format
└── Save to organized directory

Related Script: src/utils/substack_utils.py
  └── run_downloader()
  └── _download_single_article()
  └── extract_blog_slug()
</code></pre><h4 id="step-2-text-normalization">Step 2: Text Normalization </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Input:  Raw article text
Output: Normalized text

Sub-tasks:
├── Load teencode dictionary
├── Apply teencode replacements
├── Remove URLs and emojis
├── Normalize whitespace
└── (Optional) Lowercase conversion

Related Script: src/utils/text_utils.py
  └── load_teencode_dict()
  └── normalize_text()
</code></pre><h4 id="step-3-cs-chunk-extraction">Step 3: CS Chunk Extraction </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Input:  Normalized text
Output: List of CS chunks with context

Sub-tasks:
├── Split into sentences
├── Detect CS sentences (VN + EN intersection)
├── Calculate per-sentence CS ratio
├── Extract context (before/after sentences)
└── Build chunk dictionaries

Related Script: src/utils/text_utils.py
  └── contains_code_switching()
  └── extract_cs_chunks()
  └── _estimate_cs_ratio()
</code></pre><hr>
<h2 id="4-data-versioning-workflow-dvc">4. Data Versioning Workflow (DVC) </h2>
<h3 id="41-dvc-sync-daemon-automated">4.1 DVC Sync Daemon (Automated) </h3>
<p>The sync daemon automatically synchronizes data every 5 minutes with Google Drive.</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                          SYNC DAEMON WORKFLOW                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────┐    │
│    │  WAIT   │────▶│  DVC PULL   │────▶│  DVC PUSH   │────▶│  LOG    │    │
│    │ 5 min   │     │ (Fetch new) │     │ (Upload)    │     │ Result  │    │
│    └────▲────┘     └─────────────┘     └─────────────┘     └────┬────┘    │
│         │                                                       │          │
│         └───────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

Automatic sync via Docker:
- Runs as sync_service container
- Pulls new data from Google Drive remote
- Pushes local changes upstream
- Records DVC commit hashes in database

Script: src/sync_daemon.py
</code></pre><h3 id="42-manual-dvc-operations">4.2 Manual DVC Operations </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># After downloading new files</span>
dvc <span class="token function">add</span> data/raw

<span class="token comment"># Commit the tracking file</span>
<span class="token function">git</span> <span class="token function">add</span> data/raw.dvc .gitignore
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"Add new batch of data"</span>

<span class="token comment"># Push to remote storage</span>
dvc push
</code></pre><h3 id="43-pulling-existing-data">4.3 Pulling Existing Data </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># After cloning the repository</span>
dvc pull
</code></pre><h3 id="44-checking-status">4.4 Checking Status </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># See what's changed</span>
dvc status

<span class="token comment"># See file details</span>
dvc <span class="token function">diff</span>
</code></pre><hr>
<h2 id="5-label-studio-annotation-workflow">5. Label Studio Annotation Workflow </h2>
<h3 id="51-complete-annotation-flow">5.1 Complete Annotation Flow </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                      LABEL STUDIO WORKFLOW                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. PUSH SAMPLES        2. ANNOTATE           3. WEBHOOK CALLBACK           │
│  ┌─────────────┐        ┌─────────────┐       ┌─────────────────┐          │
│  │ Select RAW  │        │ Label Studio│       │ FastAPI Server  │          │
│  │ samples     │───────▶│ UI          │──────▶│ (port 8000)     │          │
│  │             │        │             │       │                 │          │
│  │ Lock sample │        │ Audio +     │       │ Check conflict  │          │
│  │ in database │        │ Transcript  │       │ Record result   │          │
│  └─────────────┘        └─────────────┘       └────────┬────────┘          │
│                                                        │                    │
│  6. EXPORT              5. UPDATE DB           4. CONFLICT?                │
│  ┌─────────────┐        ┌─────────────┐       ┌────────▼────────┐          │
│  │ Export      │        │ Create new  │       │ Compare version │          │
│  │ reviewed    │◀───────│ revision    │◀──YES─│ sync_version    │          │
│  │ data        │        │             │       │                 │          │
│  │             │        │ Unlock      │  NO   │ Flag for        │          │
│  │ DVC push    │        │ sample      │◀──────│ re-review       │          │
│  └─────────────┘        └─────────────┘       └─────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id="52-task-types">5.2 Task Types </h3>
<table>
<thead>
<tr>
<th>Task Type</th>
<th>Template</th>
<th>Input</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>transcript_correction</code></td>
<td>Audio waveform + editable text</td>
<td>RAW samples</td>
<td>Corrected transcripts</td>
</tr>
<tr>
<td><code>translation_review</code></td>
<td>Side-by-side view</td>
<td>TRANSLATED samples</td>
<td>Verified translations</td>
</tr>
<tr>
<td><code>audio_segmentation</code></td>
<td>Waveform regions</td>
<td>Audio files</td>
<td>Segment boundaries</td>
</tr>
</tbody>
</table>
<h3 id="53-conflict-resolution">5.3 Conflict Resolution </h3>
<p>When a sample is updated during annotation:</p>
<ol>
<li><strong>Detection</strong>: Webhook compares <code>sync_version</code> at annotation start vs current</li>
<li><strong>Conflict Creation</strong>: New sample created with <code>_conflict_{timestamp}</code> suffix</li>
<li><strong>Flagging</strong>: Original marked for re-review</li>
<li><strong>Resolution Options</strong>:
<ul>
<li>Keep annotated version</li>
<li>Keep updated version</li>
<li>Merge changes manually</li>
</ul>
</li>
</ol>
<h3 id="54-gold-standard-samples">5.4 Gold Standard Samples </h3>
<p>Quality control using pre-verified samples:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Set a sample as gold standard</span>
<span class="token comment"># (via database function)</span>
SELECT set_gold_standard<span class="token punctuation">(</span><span class="token string">'sample_uuid'</span>, expected_score<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># View annotator accuracy</span>
SELECT * FROM v_annotator_accuracy<span class="token punctuation">;</span>
</code></pre><hr>
<h2 id="6-export-pipeline">6. Export Pipeline </h2>
<h3 id="61-export-workflow">6.1 Export Workflow </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                         EXPORT REVIEWED DATA                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Input: REVIEWED samples from database                                      │
│                                                                             │
│  Output Structure:                                                          │
│  data/reviewed/                                                             │
│  └── {task_type}/                                                           │
│      └── {sample_id}/                                                       │
│          ├── audio.wav          # Original audio file                       │
│          ├── transcript.json    # Final corrected transcript                │
│          ├── translation.json   # Verified translation                      │
│          └── metadata.json      # Sample metadata + revision history        │
│                                                                             │
│  Script: src/export_reviewed.py                                             │
│  DVC Pipeline: dvc repro export_reviewed                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id="62-dvc-pipeline-stages">6.2 DVC Pipeline Stages </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># dvc.yaml stages</span>
<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token key atrule">export_reviewed</span><span class="token punctuation">:</span>
    <span class="token key atrule">cmd</span><span class="token punctuation">:</span> python src/export_reviewed.py <span class="token punctuation">-</span><span class="token punctuation">-</span>output<span class="token punctuation">-</span>dir data/reviewed
    <span class="token key atrule">deps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> src/export_reviewed.py
    <span class="token key atrule">outs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data/reviewed

  <span class="token key atrule">generate_manifest</span><span class="token punctuation">:</span>
    <span class="token key atrule">cmd</span><span class="token punctuation">:</span> python <span class="token punctuation">-</span>c "<span class="token punctuation">...</span>"  <span class="token comment"># Generate manifest.json</span>
    <span class="token key atrule">deps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data/reviewed
    <span class="token key atrule">outs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data/reviewed/manifest.json
</code></pre><hr>
<h2 id="7-quick-reference-script--task-mapping">7. Quick Reference: Script → Task Mapping </h2>
<table>
<thead>
<tr>
<th>Script</th>
<th>Primary Task</th>
<th>Key Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ingest_youtube.py</code></td>
<td>YouTube ingestion orchestrator</td>
<td><code>run_pipeline()</code>, <code>ingest_to_database()</code></td>
</tr>
<tr>
<td><code>ingest_substack.py</code></td>
<td>Substack ingestion orchestrator</td>
<td><code>ingest_substack()</code>, <code>process_article()</code></td>
</tr>
<tr>
<td><code>label_studio_sync.py</code></td>
<td>Label Studio integration</td>
<td><code>push()</code>, <code>pull()</code>, <code>status()</code></td>
</tr>
<tr>
<td><code>sync_daemon.py</code></td>
<td>DVC auto-sync service</td>
<td><code>run_dvc_pull()</code>, <code>run_dvc_push()</code>, <code>run_sync_loop()</code></td>
</tr>
<tr>
<td><code>export_reviewed.py</code></td>
<td>Export reviewed data</td>
<td><code>export_sample()</code>, <code>export_all_reviewed()</code></td>
</tr>
<tr>
<td><code>webhook_server.py</code></td>
<td>Annotation webhooks</td>
<td><code>handle_annotation_created()</code>, <code>check_conflict()</code></td>
</tr>
<tr>
<td><code>video_downloading_utils.py</code></td>
<td>Audio download</td>
<td><code>download_channels()</code>, <code>save_jsonl()</code></td>
</tr>
<tr>
<td><code>transcript_downloading_utils.py</code></td>
<td>Transcript download</td>
<td><code>get_transcript_info()</code>, <code>download_transcripts_from_metadata()</code></td>
</tr>
<tr>
<td><code>substack_utils.py</code></td>
<td>Article download</td>
<td><code>run_downloader()</code>, <code>list_downloaded_articles()</code></td>
</tr>
<tr>
<td><code>text_utils.py</code></td>
<td>Text processing</td>
<td><code>normalize_text()</code>, <code>extract_cs_chunks()</code></td>
</tr>
<tr>
<td><code>data_utils.py</code></td>
<td>Database operations</td>
<td><code>insert_sample()</code>, <code>insert_transcript_revision()</code>, <code>calculate_cs_ratio()</code></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="8-environment-variables">8. Environment Variables </h2>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Database connection</span>
<span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span>postgresql://admin:secret_password@localhost:5432/data_factory

<span class="token comment"># Label Studio integration</span>
<span class="token assign-left variable">LABEL_STUDIO_URL</span><span class="token operator">=</span>http://localhost:8080
<span class="token assign-left variable">LABEL_STUDIO_API_KEY</span><span class="token operator">=</span>your_api_key
<span class="token assign-left variable">LS_PROJECT_TRANSCRIPT</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">LS_PROJECT_TRANSLATION</span><span class="token operator">=</span><span class="token number">2</span>
<span class="token assign-left variable">LS_PROJECT_SEGMENTATION</span><span class="token operator">=</span><span class="token number">3</span>

<span class="token comment"># Audio serving</span>
<span class="token assign-left variable">AUDIO_SERVER_URL</span><span class="token operator">=</span>http://localhost:8081

<span class="token comment"># DVC sync configuration</span>
<span class="token assign-left variable">DVC_REMOTE</span><span class="token operator">=</span>gdrive
<span class="token assign-left variable">SYNC_INTERVAL_MINUTES</span><span class="token operator">=</span><span class="token number">5</span>
</code></pre><hr>
<h2 id="9-command-reference">9. Command Reference </h2>
<h3 id="youtube-ingestion">YouTube Ingestion </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Full pipeline with database</span>
python src/ingest_youtube.py <span class="token string">"https://youtube.com/watch?v=VIDEO_ID"</span>

<span class="token comment"># Dry run (no database writes)</span>
python src/ingest_youtube.py --dry-run <span class="token string">"https://youtube.com/watch?v=VIDEO_ID"</span>

<span class="token comment"># Skip download, use existing metadata</span>
python src/ingest_youtube.py --skip-download --dry-run
</code></pre><h3 id="substack-ingestion">Substack Ingestion </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># From URL file</span>
python src/ingest_substack.py --urls-file data/substack_urls.txt

<span class="token comment"># Dry run with existing downloads</span>
python src/ingest_substack.py --skip-download --dry-run

<span class="token comment"># Limit number of articles</span>
python src/ingest_substack.py <span class="token parameter variable">--limit</span> <span class="token number">10</span>
</code></pre><h3 id="label-studio-sync">Label Studio Sync </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Push samples for annotation</span>
python src/label_studio_sync.py push --task-type transcript_correction

<span class="token comment"># Pull completed annotations</span>
python src/label_studio_sync.py pull --task-type transcript_correction

<span class="token comment"># Check connection</span>
python src/label_studio_sync.py status
</code></pre><h3 id="dvc-sync-daemon">DVC Sync Daemon </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Run continuous sync (every 5 minutes by default)</span>
python src/sync_daemon.py

<span class="token comment"># Single sync operation</span>
python src/sync_daemon.py <span class="token parameter variable">--once</span>

<span class="token comment"># Custom interval</span>
python src/sync_daemon.py <span class="token parameter variable">--interval</span> <span class="token number">10</span>

<span class="token comment"># Push-only mode</span>
python src/sync_daemon.py <span class="token parameter variable">--once</span> <span class="token parameter variable">--push</span>
</code></pre><h3 id="export-reviewed-data">Export Reviewed Data </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Export all reviewed samples</span>
python src/export_reviewed.py --output-dir data/reviewed

<span class="token comment"># Export specific task type</span>
python src/export_reviewed.py --task-type transcript_correction

<span class="token comment"># Dry run</span>
python src/export_reviewed.py --dry-run
</code></pre><h3 id="webhook-server">Webhook Server </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Start webhook server</span>
uvicorn src.webhook_server:app <span class="token parameter variable">--host</span> <span class="token number">0.0</span>.0.0 <span class="token parameter variable">--port</span> <span class="token number">8000</span>

<span class="token comment"># Or via docker-compose</span>
<span class="token function">docker-compose</span> up webhook_server
</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>