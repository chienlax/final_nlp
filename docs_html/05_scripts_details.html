<!DOCTYPE html><html><head>
      <title>05_scripts_details</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\Quang Chien\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="05-script-details">05. Script Details </h1>
<p>This document provides detailed documentation for all scripts in the <code>src/</code> directory.</p>
<hr>
<h2 id="table-of-contents">Table of Contents </h2>
<ol>
<li><a href="#1-orchestrator-scripts">Orchestrator Scripts</a>
<ul>
<li><a href="#51-ingest_youtubepy">5.1 ingest_youtube.py</a></li>
<li><a href="#52-ingest_substackpy">5.2 ingest_substack.py</a></li>
<li><a href="#53-label_studio_syncpy">5.3 label_studio_sync.py</a></li>
<li><a href="#54-sync_daemonpy">5.4 sync_daemon.py</a></li>
<li><a href="#55-export_reviewedpy">5.5 export_reviewed.py</a></li>
<li><a href="#56-webhook_serverpy">5.6 webhook_server.py</a></li>
</ul>
</li>
<li><a href="#2-utility-modules">Utility Modules</a>
<ul>
<li><a href="#57-video_downloading_utilspy">5.7 video_downloading_utils.py</a></li>
<li><a href="#58-transcript_downloading_utilspy">5.8 transcript_downloading_utils.py</a></li>
<li><a href="#59-substack_utilspy">5.9 substack_utils.py</a></li>
<li><a href="#510-text_utilspy">5.10 text_utils.py</a></li>
<li><a href="#511-data_utilspy">5.11 data_utils.py</a></li>
</ul>
</li>
</ol>
<hr>
<h2 id="1-orchestrator-scripts">1. Orchestrator Scripts </h2>
<h3 id="51-ingest_youtubepy">5.1 ingest_youtube.py </h3>
<p><strong>Location:</strong> <code>src/ingest_youtube.py</code></p>
<p><strong>Purpose:</strong> Main orchestrator for the YouTube audio-first ingestion pipeline. Combines video download, transcript download, CS ratio calculation, and database insertion into a single workflow.</p>
<h4 id="usage">Usage </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Download and ingest a single video</span>
python src/ingest_youtube.py <span class="token string">"https://www.youtube.com/watch?v=VIDEO_ID"</span>

<span class="token comment"># Download from a channel</span>
python src/ingest_youtube.py <span class="token string">"https://www.youtube.com/@ChannelName"</span>

<span class="token comment"># Dry run (simulate without database writes)</span>
python src/ingest_youtube.py --dry-run <span class="token string">"https://youtube.com/watch?v=VIDEO_ID"</span>

<span class="token comment"># Skip download, use existing metadata.jsonl</span>
python src/ingest_youtube.py --skip-download

<span class="token comment"># Combine flags</span>
python src/ingest_youtube.py --skip-download --dry-run
</code></pre><h4 id="command-line-arguments">Command Line Arguments </h4>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>urls</code></td>
<td>positional</td>
<td>YouTube video or channel URLs to download</td>
</tr>
<tr>
<td><code>--skip-download</code></td>
<td>flag</td>
<td>Skip download step, use existing <code>metadata.jsonl</code></td>
</tr>
<tr>
<td><code>--dry-run</code></td>
<td>flag</td>
<td>Simulate ingestion without database writes</td>
</tr>
</tbody>
</table>
<h4 id="pipeline-steps">Pipeline Steps </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>[STEP 1/4] Download audio files (yt-dlp + ffmpeg)
    ↓
[STEP 2/4] Download transcripts with timestamps
    ↓
[STEP 3/4] Calculate linguistic metrics (CS ratio)
    ↓
[STEP 4/4] Ingest to database
</code></pre><h4 id="key-functions">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">run_pipeline</span><span class="token punctuation">(</span>urls<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> skip_download<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> dry_run<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Run the full YouTube ingestion pipeline.
    
    Steps:
    1. Download audio as 16kHz mono WAV
    2. Download transcripts with timestamps
    3. Calculate CS ratio for each transcript
    4. Insert records into database
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">ingest_to_database</span><span class="token punctuation">(</span>metadata_entries<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">,</span> dry_run<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Ingest metadata entries into the samples table.
    
    Returns:
        {'inserted': N, 'skipped': M, 'failed': K}
    """</span>
</code></pre><h4 id="output-files">Output Files </h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Location</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Audio</td>
<td><code>data/raw/audio/{video_id}.wav</code></td>
<td>16kHz mono WAV</td>
</tr>
<tr>
<td>Transcript</td>
<td><code>data/raw/text/{video_id}_transcript.json</code></td>
<td>JSON with timestamps</td>
</tr>
<tr>
<td>Metadata</td>
<td><code>data/raw/metadata.jsonl</code></td>
<td>Batch metadata file</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="52-ingest_substackpy">5.2 ingest_substack.py </h3>
<p><strong>Location:</strong> <code>src/ingest_substack.py</code></p>
<p><strong>Purpose:</strong> Main orchestrator for the Substack text-first ingestion pipeline. Downloads blog articles and ingests them for the TTS generation workflow.</p>
<h4 id="usage-1">Usage </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># From URLs file</span>
python src/ingest_substack.py --urls-file data/substack_urls.txt

<span class="token comment"># Process existing downloads only</span>
python src/ingest_substack.py --skip-download

<span class="token comment"># Dry run mode</span>
python src/ingest_substack.py --dry-run

<span class="token comment"># Limit number of articles</span>
python src/ingest_substack.py <span class="token parameter variable">--limit</span> <span class="token number">10</span>
</code></pre><h4 id="command-line-arguments-1">Command Line Arguments </h4>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--urls-file</code></td>
<td>path</td>
<td><code>data/substack_urls.txt</code></td>
<td>File containing Substack URLs</td>
</tr>
<tr>
<td><code>--download-dir</code></td>
<td>path</td>
<td><code>data/substack_downloads</code></td>
<td>Output directory</td>
</tr>
<tr>
<td><code>--teencode-file</code></td>
<td>path</td>
<td><code>data/teencode.txt</code></td>
<td>Teencode dictionary</td>
</tr>
<tr>
<td><code>--skip-download</code></td>
<td>flag</td>
<td>-</td>
<td>Skip download, process existing</td>
</tr>
<tr>
<td><code>--dry-run</code></td>
<td>flag</td>
<td>-</td>
<td>Preview without database writes</td>
</tr>
<tr>
<td><code>--limit</code></td>
<td>int</td>
<td>-</td>
<td>Max articles to process</td>
</tr>
</tbody>
</table>
<h4 id="key-functions-1">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">ingest_substack</span><span class="token punctuation">(</span>
    urls<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    skip_download<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">,</span>
    dry_run<span class="token punctuation">:</span> <span class="token builtin">bool</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Main entry point for Substack ingestion.
    
    Returns:
        {'total': N, 'processed': M, 'ingested': K, 'skipped': S, 'errors': E}
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">process_article</span><span class="token punctuation">(</span>
    article_path<span class="token punctuation">:</span> Path<span class="token punctuation">,</span>
    source_url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    teencode_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    conn<span class="token punctuation">,</span>
    dry_run<span class="token punctuation">:</span> <span class="token builtin">bool</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Process a single article and ingest into database.
    
    Returns:
        sample_id if successful, None otherwise
    """</span>
</code></pre><h4 id="output-files-1">Output Files </h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Location</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Articles</td>
<td><code>data/raw/text/substack/{blog_slug}/{article}.txt</code></td>
<td>Cleaned text</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="53-label_studio_syncpy">5.3 label_studio_sync.py </h3>
<p><strong>Location:</strong> <code>src/label_studio_sync.py</code></p>
<p><strong>Purpose:</strong> Synchronizes data between the PostgreSQL database and Label Studio for human annotation tasks.</p>
<h4 id="usage-2">Usage </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Push samples to Label Studio for annotation</span>
python src/label_studio_sync.py push --task-type transcript_correction

<span class="token comment"># Pull completed annotations back to database</span>
python src/label_studio_sync.py pull --task-type transcript_correction

<span class="token comment"># Check connection status</span>
python src/label_studio_sync.py status
</code></pre><h4 id="environment-variables">Environment Variables </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token assign-left variable">LABEL_STUDIO_URL</span><span class="token operator">=</span>http://localhost:8080
<span class="token assign-left variable">LABEL_STUDIO_API_KEY</span><span class="token operator">=</span>your_api_key
<span class="token assign-left variable">LS_PROJECT_TRANSCRIPT</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">LS_PROJECT_TRANSLATION</span><span class="token operator">=</span><span class="token number">2</span>
<span class="token assign-left variable">LS_PROJECT_SEGMENTATION</span><span class="token operator">=</span><span class="token number">3</span>
</code></pre><h4 id="task-types">Task Types </h4>
<table>
<thead>
<tr>
<th>Task Type</th>
<th>Description</th>
<th>Project</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>transcript_verification</code></td>
<td>Verify/correct ASR transcripts</td>
<td><code>LS_PROJECT_TRANSCRIPT</code></td>
</tr>
<tr>
<td><code>timestamp_alignment</code></td>
<td>Verify word-level timestamps</td>
<td><code>LS_PROJECT_TRANSCRIPT</code></td>
</tr>
<tr>
<td><code>translation_review</code></td>
<td>Review LLM translations</td>
<td><code>LS_PROJECT_TRANSLATION</code></td>
</tr>
<tr>
<td><code>quality_assessment</code></td>
<td>Final quality check</td>
<td><code>LS_PROJECT_TRANSLATION</code></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="54-sync_daemonpy">5.4 sync_daemon.py </h3>
<p><strong>Location:</strong> <code>src/sync_daemon.py</code></p>
<p><strong>Purpose:</strong> Automatic DVC synchronization daemon that runs every 5 minutes to keep data in sync between local storage and Google Drive remote.</p>
<h4 id="usage-3">Usage </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Run continuous sync (default: every 5 minutes)</span>
python src/sync_daemon.py

<span class="token comment"># Single sync operation</span>
python src/sync_daemon.py <span class="token parameter variable">--once</span>

<span class="token comment"># Custom interval (10 minutes)</span>
python src/sync_daemon.py <span class="token parameter variable">--interval</span> <span class="token number">10</span>

<span class="token comment"># Push-only mode (upload local changes)</span>
python src/sync_daemon.py <span class="token parameter variable">--once</span> <span class="token parameter variable">--push</span>
</code></pre><h4 id="command-line-arguments-2">Command Line Arguments </h4>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--once</code></td>
<td>flag</td>
<td>-</td>
<td>Run single sync and exit</td>
</tr>
<tr>
<td><code>--interval</code></td>
<td>int</td>
<td>5</td>
<td>Sync interval in minutes</td>
</tr>
<tr>
<td><code>--push</code></td>
<td>flag</td>
<td>-</td>
<td>Push-only mode (upload changes)</td>
</tr>
</tbody>
</table>
<h4 id="key-functions-2">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">run_dvc_pull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Execute DVC pull to fetch new data from remote.
    
    Returns:
        {
            'success': bool,
            'files_updated': int,
            'commit_hash': str,
            'message': str
        }
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">run_dvc_push</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Execute DVC push to upload local changes.
    
    Returns:
        {
            'success': bool,
            'files_pushed': int,
            'commit_hash': str,
            'message': str
        }
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">run_sync_loop</span><span class="token punctuation">(</span>interval_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Run continuous sync loop.
    
    - Executes pull → push every interval
    - Logs results to console
    - Records commit hashes in database
    - Handles interrupts gracefully
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">run_once</span><span class="token punctuation">(</span>push_only<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Run single sync operation.
    
    Args:
        push_only: If True, only push (no pull)
    
    Returns:
        Sync result dictionary
    """</span>
</code></pre><h4 id="environment-variables-1">Environment Variables </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token assign-left variable">DVC_REMOTE</span><span class="token operator">=</span>gdrive               <span class="token comment"># Remote name (configured in .dvc/config)</span>
<span class="token assign-left variable">SYNC_INTERVAL_MINUTES</span><span class="token operator">=</span><span class="token number">5</span>         <span class="token comment"># Default interval</span>
<span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span>postgresql://<span class="token punctuation">..</span>.   <span class="token comment"># For logging sync results</span>
</code></pre><h4 id="docker-integration">Docker Integration </h4>
<p>Runs as <code>sync_service</code> container:</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">sync_service</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">context</span><span class="token punctuation">:</span> .
    <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile.ingest
  <span class="token key atrule">command</span><span class="token punctuation">:</span> python src/sync_daemon.py <span class="token punctuation">-</span><span class="token punctuation">-</span>interval 5
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ./data<span class="token punctuation">:</span>/app/data
</code></pre><hr>
<h3 id="55-export_reviewedpy">5.5 export_reviewed.py </h3>
<p><strong>Location:</strong> <code>src/export_reviewed.py</code></p>
<p><strong>Purpose:</strong> Export reviewed and verified samples from the database to a structured output directory for downstream processing.</p>
<h4 id="usage-4">Usage </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Export all reviewed samples</span>
python src/export_reviewed.py --output-dir data/reviewed

<span class="token comment"># Export specific task type</span>
python src/export_reviewed.py --task-type transcript_correction

<span class="token comment"># Dry run (preview only)</span>
python src/export_reviewed.py --dry-run

<span class="token comment"># Limit number of exports</span>
python src/export_reviewed.py <span class="token parameter variable">--limit</span> <span class="token number">100</span>
</code></pre><h4 id="command-line-arguments-3">Command Line Arguments </h4>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--output-dir</code></td>
<td>path</td>
<td><code>data/reviewed</code></td>
<td>Output directory</td>
</tr>
<tr>
<td><code>--task-type</code></td>
<td>str</td>
<td>-</td>
<td>Filter by task type</td>
</tr>
<tr>
<td><code>--dry-run</code></td>
<td>flag</td>
<td>-</td>
<td>Preview without writing</td>
</tr>
<tr>
<td><code>--limit</code></td>
<td>int</td>
<td>-</td>
<td>Maximum samples to export</td>
</tr>
</tbody>
</table>
<h4 id="output-structure">Output Structure </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>data/reviewed/
└── {task_type}/
    └── {sample_id}/
        ├── audio.wav           # Original audio file
        ├── transcript.json     # Final corrected transcript
        ├── translation.json    # Verified translation (if available)
        └── metadata.json       # Sample metadata + revision history
</code></pre><h4 id="key-functions-3">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">export_sample</span><span class="token punctuation">(</span>
    sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    output_dir<span class="token punctuation">:</span> Path<span class="token punctuation">,</span>
    include_audio<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Export a single reviewed sample.
    
    Returns:
        {
            'sample_id': str,
            'files_exported': List[str],
            'total_size_bytes': int,
            'success': bool
        }
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">export_all_reviewed</span><span class="token punctuation">(</span>
    output_dir<span class="token punctuation">:</span> Path<span class="token punctuation">,</span>
    task_type<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    dry_run<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Export all reviewed samples to output directory.
    
    Returns:
        {
            'total_samples': int,
            'exported': int,
            'skipped': int,
            'errors': int,
            'total_size_mb': float
        }
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">generate_manifest</span><span class="token punctuation">(</span>output_dir<span class="token punctuation">:</span> Path<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Generate manifest.json with metadata for all exported samples.
    
    Returns:
        Manifest dictionary with sample list and statistics
    """</span>
</code></pre><h4 id="dvc-pipeline-integration">DVC Pipeline Integration </h4>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># dvc.yaml</span>
<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token key atrule">export_reviewed</span><span class="token punctuation">:</span>
    <span class="token key atrule">cmd</span><span class="token punctuation">:</span> python src/export_reviewed.py <span class="token punctuation">-</span><span class="token punctuation">-</span>output<span class="token punctuation">-</span>dir data/reviewed
    <span class="token key atrule">deps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> src/export_reviewed.py
    <span class="token key atrule">outs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data/reviewed
</code></pre><hr>
<h3 id="56-webhook_serverpy">5.6 webhook_server.py </h3>
<p><strong>Location:</strong> <code>src/webhook_server.py</code></p>
<p><strong>Purpose:</strong> FastAPI server that receives webhook callbacks from Label Studio when annotations are created or updated. Handles conflict detection and database recording.</p>
<h4 id="usage-5">Usage </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Start webhook server (development)</span>
uvicorn src.webhook_server:app <span class="token parameter variable">--host</span> <span class="token number">0.0</span>.0.0 <span class="token parameter variable">--port</span> <span class="token number">8000</span> <span class="token parameter variable">--reload</span>

<span class="token comment"># Start webhook server (production)</span>
uvicorn src.webhook_server:app <span class="token parameter variable">--host</span> <span class="token number">0.0</span>.0.0 <span class="token parameter variable">--port</span> <span class="token number">8000</span> <span class="token parameter variable">--workers</span> <span class="token number">4</span>

<span class="token comment"># Via Docker Compose</span>
<span class="token function">docker-compose</span> up webhook_server
</code></pre><h4 id="api-endpoints">API Endpoints </h4>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/webhook</code></td>
<td>Receive Label Studio annotation callbacks</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/conflicts</code></td>
<td>List all detected conflicts</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/resolve-conflict/{id}</code></td>
<td>Resolve a conflict</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/stats</code></td>
<td>Get annotation statistics</td>
</tr>
<tr>
<td>GET</td>
<td><code>/health</code></td>
<td>Health check endpoint</td>
</tr>
</tbody>
</table>
<h4 id="webhook-payload-format">Webhook Payload Format </h4>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"ANNOTATION_CREATED"</span><span class="token punctuation">,</span>
  <span class="token property">"annotation"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
    <span class="token property">"completed_by"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"result"</span><span class="token operator">:</span> <span class="token punctuation">[</span>...<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"created_at"</span><span class="token operator">:</span> <span class="token string">"2024-01-01T12:00:00Z"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"task"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">456</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"sample_id"</span><span class="token operator">:</span> <span class="token string">"uuid-here"</span><span class="token punctuation">,</span>
      <span class="token property">"sync_version"</span><span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"project"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Transcript Correction"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="key-functions-4">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/webhook"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">handle_webhook</span><span class="token punctuation">(</span>payload<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Handle Label Studio webhook callbacks.
    
    Processes:
    - ANNOTATION_CREATED: Check conflict, record result
    - ANNOTATION_UPDATED: Update existing annotation
    - TASK_COMPLETED: Mark sample as reviewed
    
    Returns:
        {'status': 'success' | 'conflict_detected', 'message': str}
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">check_conflict</span><span class="token punctuation">(</span>sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> annotation_sync_version<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check if sample was modified during annotation.
    
    Compares sync_version at annotation start vs current database value.
    
    Returns:
        True if conflict detected
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">record_annotation_to_db</span><span class="token punctuation">(</span>
    sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    annotation_result<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span>
    annotator_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    task_type<span class="token punctuation">:</span> <span class="token builtin">str</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Record completed annotation to database.
    
    - Creates new transcript/translation revision
    - Updates sample processing state
    - Unlocks sample
    
    Returns:
        UUID of created revision
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">create_conflict_sample</span><span class="token punctuation">(</span>
    original_sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    annotation_result<span class="token punctuation">:</span> Dict
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Create new sample from conflict annotation.
    
    - Clones original sample with '_conflict_{timestamp}' suffix
    - Stores annotation result
    - Flags both for re-review
    
    Returns:
        UUID of conflict sample
    """</span>
</code></pre><h4 id="environment-variables-2">Environment Variables </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token assign-left variable">WEBHOOK_SECRET</span><span class="token operator">=</span>your_secret_key    <span class="token comment"># For payload validation (optional)</span>
<span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span>postgresql://<span class="token punctuation">..</span>.     <span class="token comment"># Database connection</span>
<span class="token assign-left variable">LABEL_STUDIO_URL</span><span class="token operator">=</span>http://<span class="token punctuation">..</span>.       <span class="token comment"># For API callbacks</span>
</code></pre><h4 id="conflict-resolution-api">Conflict Resolution API </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># List conflicts</span>
<span class="token function">curl</span> http://localhost:8000/api/conflicts

<span class="token comment"># Resolve conflict (keep annotated version)</span>
<span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:8000/api/resolve-conflict/123 <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{"resolution": "keep_annotated"}'</span>

<span class="token comment"># Resolve conflict (keep updated version)</span>
<span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:8000/api/resolve-conflict/123 <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{"resolution": "keep_updated"}'</span>
</code></pre><hr>
<h2 id="2-utility-modules">2. Utility Modules </h2>
<h3 id="57-video_downloading_utilspy">5.7 video_downloading_utils.py </h3>
<p><strong>Location:</strong> <code>src/utils/video_downloading_utils.py</code></p>
<p><strong>Purpose:</strong> Downloads YouTube videos as 16kHz mono WAV files using yt-dlp and ffmpeg.</p>
<h4 id="constants">Constants </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>SAMPLE_RATE <span class="token operator">=</span> <span class="token number">16000</span>      <span class="token comment"># 16kHz as per project spec</span>
CHANNELS <span class="token operator">=</span> <span class="token number">1</span>             <span class="token comment"># Mono</span>
MIN_DURATION <span class="token operator">=</span> <span class="token number">120</span>       <span class="token comment"># 2 minutes minimum</span>
MAX_DURATION <span class="token operator">=</span> <span class="token number">3600</span>      <span class="token comment"># 60 minutes maximum</span>
OUTPUT_DIR <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"data/raw/audio"</span><span class="token punctuation">)</span>
METADATA_FILE <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"data/raw/metadata.jsonl"</span><span class="token punctuation">)</span>
</code></pre><h4 id="key-functions-5">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">download_channels</span><span class="token punctuation">(</span>url_list<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Download audio from YouTube channels/videos as 16kHz mono WAV.
    
    Features:
    - Duration filter (2-60 minutes)
    - Best audio quality extraction
    - Automatic resampling to 16kHz mono
    - Progress hooks for metadata capture
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">_duration_filter</span><span class="token punctuation">(</span>info_dict<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> incomplete<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Filter function for yt-dlp to skip videos outside duration range.
    
    Returns:
        None if video passes, error message string if rejected
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">save_jsonl</span><span class="token punctuation">(</span>append<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Save downloaded video metadata to JSONL file.
    
    Supports append mode with deduplication by video ID.
    """</span>
</code></pre><h4 id="yt-dlp-configuration">yt-dlp Configuration </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>ydl_opts <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'format'</span><span class="token punctuation">:</span> <span class="token string">'bestaudio/best'</span><span class="token punctuation">,</span>
    <span class="token string">'match_filter'</span><span class="token punctuation">:</span> _duration_filter<span class="token punctuation">,</span>
    <span class="token string">'postprocessors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">'key'</span><span class="token punctuation">:</span> <span class="token string">'FFmpegExtractAudio'</span><span class="token punctuation">,</span> <span class="token string">'preferredcodec'</span><span class="token punctuation">:</span> <span class="token string">'wav'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">'key'</span><span class="token punctuation">:</span> <span class="token string">'FFmpegMetadata'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'postprocessor_args'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'ffmpeg'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'-ar'</span><span class="token punctuation">,</span> <span class="token string">'16000'</span><span class="token punctuation">,</span> <span class="token string">'-ac'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 16kHz mono</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'outtmpl'</span><span class="token punctuation">:</span> <span class="token string">'data/raw/audio/%(id)s.%(ext)s'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h3 id="58-transcript_downloading_utilspy">5.8 transcript_downloading_utils.py </h3>
<p><strong>Location:</strong> <code>src/utils/transcript_downloading_utils.py</code></p>
<p><strong>Purpose:</strong> Downloads YouTube transcripts with timestamps for audio segmentation.</p>
<h4 id="key-functions-6">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">get_transcript_info</span><span class="token punctuation">(</span>video_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Fetch transcript with subtitle type detection.
    
    Priority order:
    1. Manual English transcript
    2. Auto-generated English transcript
    3. Manual Vietnamese transcript
    4. Auto-generated Vietnamese transcript
    
    Returns:
        {
            'segments': [{text, start, duration, end}, ...],
            'text': 'Full transcript text',
            'subtitle_type': 'Manual' | 'Auto-generated' | 'Not Available',
            'language': 'en' | 'vi',
            'error': None | 'error message'
        }
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">download_transcripts_from_metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Download transcripts for all videos in metadata.jsonl.
    
    - Saves as JSON files with timestamps
    - Updates metadata.jsonl with transcript info
    - Skips existing transcripts
    """</span>
</code></pre><h4 id="output-json-format">Output JSON Format </h4>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"video_id"</span><span class="token operator">:</span> <span class="token string">"OXPQQIREOzk"</span><span class="token punctuation">,</span>
  <span class="token property">"language"</span><span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">,</span>
  <span class="token property">"subtitle_type"</span><span class="token operator">:</span> <span class="token string">"Manual"</span><span class="token punctuation">,</span>
  <span class="token property">"segments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Hello everyone"</span><span class="token punctuation">,</span>
      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token number">0.47</span><span class="token punctuation">,</span>
      <span class="token property">"duration"</span><span class="token operator">:</span> <span class="token number">0.95</span><span class="token punctuation">,</span>
      <span class="token property">"end"</span><span class="token operator">:</span> <span class="token number">1.42</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"full_text"</span><span class="token operator">:</span> <span class="token string">"Hello everyone..."</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h3 id="59-substack_utilspy">5.9 substack_utils.py </h3>
<p><strong>Location:</strong> <code>src/utils/substack_utils.py</code></p>
<p><strong>Purpose:</strong> Downloads Substack blog articles using Python requests and BeautifulSoup.</p>
<h4 id="constants-1">Constants </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>OUTPUT_DIR <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"data/raw/text/substack"</span><span class="token punctuation">)</span>
URLS_FILE <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"data/substack_urls.txt"</span><span class="token punctuation">)</span>
</code></pre><h4 id="key-functions-7">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">run_downloader</span><span class="token punctuation">(</span>
    urls<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    urls_file<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    output_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Download Substack blog posts.
    
    Returns:
        List of metadata dictionaries for downloaded articles
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">_download_single_article</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> output_dir<span class="token punctuation">:</span> Path<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Download a single Substack article.
    
    - Fetches HTML via requests
    - Parses with BeautifulSoup
    - Extracts title and body content
    - Saves as plain text
    
    Returns:
        Metadata dict or None if failed
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">extract_blog_slug</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Extract blog slug from URL.
    
    Handles:
    - https://myblog.substack.com → 'myblog'
    - https://www.customdomain.com → 'customdomain'
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">list_downloaded_articles</span><span class="token punctuation">(</span>output_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    List all downloaded articles in the output directory.
    
    Returns:
        List of metadata dicts with file paths
    """</span>
</code></pre><hr>
<h3 id="510-text_utilspy">5.10 text_utils.py </h3>
<p><strong>Location:</strong> <code>src/utils/text_utils.py</code></p>
<p><strong>Purpose:</strong> Text processing utilities including normalization, teencode replacement, and code-switching detection.</p>
<h4 id="constants-2">Constants </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Vietnamese particles for CS detection</span>
VN_PARTICLES <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'và'</span><span class="token punctuation">,</span> <span class="token string">'là'</span><span class="token punctuation">,</span> <span class="token string">'của'</span><span class="token punctuation">,</span> <span class="token string">'những'</span><span class="token punctuation">,</span> <span class="token string">'các'</span><span class="token punctuation">,</span> <span class="token string">'này'</span><span class="token punctuation">,</span> <span class="token string">'đó'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

<span class="token comment"># English stop words for CS detection</span>
EN_STOP_WORDS <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'the'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'an'</span><span class="token punctuation">,</span> <span class="token string">'and'</span><span class="token punctuation">,</span> <span class="token string">'or'</span><span class="token punctuation">,</span> <span class="token string">'but'</span><span class="token punctuation">,</span> <span class="token string">'so'</span><span class="token punctuation">,</span> <span class="token string">'is'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre><h4 id="key-functions-8">Key Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">load_teencode_dict</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Load teencode dictionary from file.
    
    Format: teencode&lt;TAB&gt;replacement (one per line)
    
    Example:
        ko\tkhông
        dc\tđược
        cx\tcũng
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">normalize_text</span><span class="token punctuation">(</span>
    text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    teencode_dict<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    lowercase<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    remove_urls<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    remove_emojis<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Normalize Vietnamese text.
    
    Operations:
    1. Lowercase conversion
    2. URL removal
    3. Emoji removal
    4. Teencode replacement
    5. Whitespace normalization
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">contains_code_switching</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check if text contains code-switching.
    
    Uses "Intersection Rule":
    - Must have ≥1 Vietnamese particle AND
    - Must have ≥1 English stop word
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">extract_cs_chunks</span><span class="token punctuation">(</span>
    text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    context_sentences<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    min_cs_ratio<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.1</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Extract code-switching chunks with context.
    
    Returns:
        [{
            'cs_sentence': 'The CS sentence',
            'context_before': ['Previous sentence'],
            'context_after': ['Next sentence'],
            'full_chunk': 'Complete chunk text',
            'cs_ratio': 0.35,
            'sentence_index': 5
        }, ...]
    """</span>
</code></pre><hr>
<h3 id="511-data_utilspy">5.11 data_utils.py </h3>
<p><strong>Location:</strong> <code>src/utils/data_utils.py</code></p>
<p><strong>Purpose:</strong> Database connectivity and operations for PostgreSQL. Handles all CRUD operations for the multi-table schema.</p>
<h4 id="database-connection">Database Connection </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">get_pg_connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> psycopg2<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span>connection<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Establish PostgreSQL connection.
    
    Uses DATABASE_URL environment variable or defaults to:
    postgresql://admin:secret_password@localhost:5432/data_factory
    """</span>
</code></pre><h4 id="source-operations">Source Operations </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">get_or_create_source</span><span class="token punctuation">(</span>
    source_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    external_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    url<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    metadata<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Get existing source or create new one.
    
    source_type options:
    - 'youtube_with_transcript'
    - 'youtube_without_transcript'
    - 'substack'
    - 'manual_upload'
    
    Returns:
        UUID of the source
    """</span>
</code></pre><h4 id="sample-operations">Sample Operations </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">insert_sample</span><span class="token punctuation">(</span>
    content_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>           <span class="token comment"># 'audio_primary' or 'text_primary'</span>
    pipeline_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>          <span class="token comment"># Pipeline this sample follows</span>
    audio_file_path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    text_file_path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    external_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>     <span class="token comment"># Video ID, article slug</span>
    source_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    duration_seconds<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    cs_ratio<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    source_metadata<span class="token punctuation">:</span> Dict <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    acoustic_metadata<span class="token punctuation">:</span> Dict <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    linguistic_metadata<span class="token punctuation">:</span> Dict <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    priority<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Insert a new sample into the samples table.
    
    Returns:
        UUID of the inserted sample
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">sample_exists</span><span class="token punctuation">(</span>
    audio_file_path<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    external_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check if a sample already exists in the database.
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">get_sample</span><span class="token punctuation">(</span>sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Retrieve a sample by ID.
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">transition_state</span><span class="token punctuation">(</span>
    sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    new_state<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    executor<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">'system'</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Transition sample to a new processing state.
    
    Valid states:
    RAW → ALIGNED → SEGMENTED → ENHANCED → TRANSLATED → REVIEWED
    """</span>
</code></pre><h4 id="revision-operations">Revision Operations </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">insert_transcript_revision</span><span class="token punctuation">(</span>
    sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    transcript_text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    revision_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>           <span class="token comment"># 'raw', 'asr_generated', 'human_corrected', 'mfa_aligned'</span>
    revision_source<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 'youtube_api', 'whisper', 'annotator_123'</span>
    timestamps<span class="token punctuation">:</span> List <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>      <span class="token comment"># [{start_ms, end_ms, text}, ...]</span>
    metadata<span class="token punctuation">:</span> Dict <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Insert a new transcript revision.
    
    Returns:
        UUID of the revision
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">get_latest_transcript</span><span class="token punctuation">(</span>sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Get the latest transcript revision for a sample.
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">insert_translation_revision</span><span class="token punctuation">(</span>
    sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    translation_text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    target_language<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    revision_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>           <span class="token comment"># 'llm_generated', 'human_corrected', 'final'</span>
    revision_source<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    source_transcript_revision_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    confidence_score<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Insert a new translation revision.
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">get_latest_translation</span><span class="token punctuation">(</span>sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Get the latest translation revision for a sample.
    """</span>
</code></pre><h4 id="query-operations">Query Operations </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">get_review_queue</span><span class="token punctuation">(</span>
    task_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span>
    min_priority<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Get samples ready for review in Label Studio.
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">get_pipeline_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Get processing statistics by pipeline and state.
    """</span>
</code></pre><h4 id="utility-functions">Utility Functions </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">calculate_cs_ratio</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Calculate code-switching ratio of a text.
    
    Uses word-level detection of Vietnamese and English tokens.
    
    Returns:
        Float between 0.0 and 1.0
    """</span>

<span class="token keyword keyword-def">def</span> <span class="token function">log_processing</span><span class="token punctuation">(</span>
    sample_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    step_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    status<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    input_state<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    output_state<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    metadata<span class="token punctuation">:</span> Dict <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Log a processing step to the audit trail.
    """</span>
</code></pre><hr>
<h2 id="3-directory-structure">3. Directory Structure </h2>
<pre data-role="codeBlock" data-info="" class="language-text"><code>src/
├── ingest_youtube.py           # YouTube ingestion orchestrator
├── ingest_substack.py          # Substack ingestion orchestrator
├── label_studio_sync.py        # Label Studio integration
├── sync_daemon.py              # DVC auto-sync service
├── export_reviewed.py          # Export reviewed data
├── webhook_server.py           # FastAPI webhook handler
└── utils/
    ├── __init__.py
    ├── data_utils.py           # Database operations
    ├── video_downloading_utils.py   # YouTube audio download
    ├── transcript_downloading_utils.py  # YouTube transcript download
    ├── substack_utils.py       # Substack article download
    └── text_utils.py           # Text processing utilities
</code></pre><hr>
<h2 id="4-dependencies">4. Dependencies </h2>
<table>
<thead>
<tr>
<th>Package</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>yt-dlp</code></td>
<td>YouTube video/audio download</td>
</tr>
<tr>
<td><code>youtube-transcript-api</code></td>
<td>YouTube transcript API</td>
</tr>
<tr>
<td><code>requests</code></td>
<td>HTTP requests</td>
</tr>
<tr>
<td><code>beautifulsoup4</code></td>
<td>HTML parsing</td>
</tr>
<tr>
<td><code>lxml</code></td>
<td>XML/HTML parser</td>
</tr>
<tr>
<td><code>psycopg2-binary</code></td>
<td>PostgreSQL driver</td>
</tr>
<tr>
<td><code>dvc[gdrive]</code></td>
<td>Data version control with Google Drive</td>
</tr>
<tr>
<td><code>fastapi</code></td>
<td>Webhook server framework</td>
</tr>
<tr>
<td><code>uvicorn[standard]</code></td>
<td>ASGI server for FastAPI</td>
</tr>
<tr>
<td><code>pydantic</code></td>
<td>Data validation</td>
</tr>
<tr>
<td><code>python-multipart</code></td>
<td>Form data handling</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="5-error-handling">5. Error Handling </h2>
<p>All scripts follow consistent error handling patterns:</p>
<ol>
<li><strong>Validation Errors</strong>: Raised for invalid inputs (missing files, bad URLs)</li>
<li><strong>Network Errors</strong>: Caught and logged, processing continues</li>
<li><strong>Database Errors</strong>: Connection errors are caught, data saved to JSONL for retry</li>
<li><strong>Processing Errors</strong>: Individual item failures don't stop batch processing</li>
</ol>
<p>Example pattern:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> process_item<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    stats<span class="token punctuation">[</span><span class="token string">'success'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token keyword keyword-except">except</span> SpecificError <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[ERROR] </span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    stats<span class="token punctuation">[</span><span class="token string">'failed'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword keyword-continue">continue</span>  <span class="token comment"># Process next item</span>
</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>